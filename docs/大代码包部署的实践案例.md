使用fc组件进行部署对于压缩后的代码包大小有限制。不超过50M的情况下，默认的s.yaml配置文件就足以应对。对于超过50M的不同大小范围，要进行不同的应对方式。


## 1 代码包大于50M小于等于100M

此时使用默认配置进行部署，会有如下报错提示：

![](https://raykie.top/img/%2850%2C100%5Dcase.png)

基本应对思路是使用阿里云oss对象存储服务，创建一个用于用于存放代码包的bucket，随后在s.yaml文件中配置ossBucket字段，即可进行部署。

步骤如下：

1. 进入[阿里云oss控制台](https://oss.console.aliyun.com/)，创建bucket。如无特殊需求，bucket可按默认配置创建。
2. 在s.yaml文件中，相应的服务下配置ossBucket字段，值为你想使用的bucket名称。

s配置文件示例如下：
```
edition: 1.0.0          #  命令行YAML规范版本，遵循语义化版本（Semantic Versioning）规范
name: fcDeployApp       #  项目名称
access: "default"  #  秘钥别名

services:
  fc-deploy-test: #  服务名称
    component: devsapp/fc  # 组件名称
    props: #  组件的属性值
      region: cn-hangzhou
      service:
        name: fc-deploy-service
        description: 'demo for fc-deploy component'
        internetAccess: true
      function:
        name: http-trigger-function
        description: this is a test
        runtime: nodejs12
        codeUri: ./code
        ossBucket: your-bucket-name # 填写你想使用的bucket的名称
        # ossKey:  # conflict with codeUri
        handler: index.handler
        memorySize: 128
        timeout: 60
      triggers:
        - name: httpTrigger
          type: http
          config:
            authType: anonymous
            methods:
              - GET
      customDomains:
        - domainName: auto
          protocol: HTTP
          routeConfigs:
            - path: /*
              methods:
                - GET
# 函数计算FC组件文档参考地址：https://github.com/devsapp/fc
```

执行`s deploy`部署成功以后，我们可以直接在函数计算控制台>服务及函数>点击该函数名称>代码执行中，看到我们的代码包已经完整地部署成功了。

![](https://raykie.top/img/40-100%E6%88%90%E5%8A%9F.png)


## 2 代码包大于100M

当压缩后的代码包大于100M时，有三种策略用以部署：使用Nas文件系统辅助存储、使用函数计算的层（Layer）、将函数转换成custom-container（需要对代码进行一定的改造）。

### 2.1 使用NAS文件系统辅助存储

对于一个大代码包，其占用空间较多的一般是依赖包（比如node_modules）或者静态数据资源（比如训练集、数据包）。所以，我们可以使用NAS文件系统来存储这些占用大多数空间的数据，之后配合一个简单的.fcignore文件，就能把剩余的部分部署到函数计算。

步骤大致分为3步：

1. 初始化文件系统
2. 上传大文件
3. 修改配置
4. 部署函数

#### 2.1.1 初始化文件系统

要使用NAS文件系统，首先需要在阿里云[文件存储控制台](https://nasnext.console.aliyun.com/)开通这项服务。随后，可以手动在控制台创建文件系统，也可以在本地利用s工具自动创建。接下来的流程介绍在本地利用s工具自动初始化。

假设现有一个http应用，结构如下：

```
--project
  |--s.yaml
  |--.fcignore
  |--code
     |--node_modules
     |--index.js
     |--package.json
     |--package-lock.json
```

首先，在s.yaml文件对应的服务下，找到service字段，在其中添加一个`nasConfig: auto`键值对。

```
services:
  fc-deploy-test: #  服务名称
    component: devsapp/fc  # 组件名称
    props: #  组件的属性值
      region: cn-hangzhou
      service:
        name: fc-deploy-service
        description: 'demo for fc-deploy component'
        nasConfig: auto
        internetAccess: true
```

随后，在有s.yaml文件的目录下，执行`s fc-deploy-test nas init`指令，根据你配置的auto属性，fc组件会帮你执行一系列流程创建一个文件系统。最后终端会输出生成的文件系统的基本信息：

```
fc-deploy-test:
  userId: 10003
  groupId: 10003
  mountPoints:
    - serverAddr: xxxxxxxxxxxxx.cn-hangzhou.nas.aliyuncs.com
      nasDir: /fc-deploy-service
      fcDir: /mnt/auto
```

> nas是fc组件提供的与文件存储服务相关的指令，你可以执行`s fc-deploy-test nas -h`来查看具体的副指令信息。

#### 2.1.2 上传大文件

在有s.yaml文件的目录下，执行`s fc-deploy-test nas upload -r code/node_modules nas:///mnt/auto`指令。其中`fc-deploy-test`是你的服务名称，nas是由fc组件提供的指令，upload表示上，-r参数表示递归地处理目标路径下的文件夹，最后的路径是在上一步中生成的存储路径，以auto方式生成的固定为`/mnt/auto`。

#### 2.1.3 修改配置

完成了大文件的传输之后，我们需要在部署的过程中忽略该大文件，还需要在这种情况下告诉系统那些文件的路径，这就需要配置环境变量。

首先，类似`.gitignore`，fc组件会根据`.fcignore`忽略其中的文件。对于这个例子而言，我们只要写入一个`node_modules`就可以了。

在本例中，我们上传的是nodejs环境的依赖包，所以需要在function中添加environmentVariables字段，在其子字段中添加`NODE_PATH: /mnt/auto/node_modules`键值对。如下所示：

```
function:
  name: http-trigger-function
  description: this is a test
  runtime: nodejs12
  codeUri: ./code
  # ossBucket:
  # ossKey:  # conflict with codeUri
  handler: index.handler
  memorySize: 128
  timeout: 60
  environmentVariables:
    NODE_PATH: /mnt/auto/node_modules
```

对于不同的项目，使用到的环境变量名称各不相同。比如，对于python解释器而言，它是通过PYTHONPATH这个环境变量来查找模块的，所以就应该在环境变量中添加`PYTHONPATH: /yourpath`。

#### 2.1.4 部署函数

目前，所有的准备工作都已完成，只需要使用`s deploy`指令将你的函数部署即可。

## 3 更多实践案例

- [猫狗分类](https://github.com/awesome-fc/cat-dog-classify)
- [情绪识别](https://developer.aliyun.com/article/785367)




